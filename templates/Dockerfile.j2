# Generated by AutoPipe - Deterministic CI/CD Pipeline Generator
# Compatible with both BuildKit and legacy Docker builder
# Language: {{ stack.language }}
# Framework: {{ stack.framework }}
# Build Tool: {{ stack.build_tool }}

{% set project_dir = stack.project_root or '.' %}
{% set source_dir = stack.source_dir or 'src' %}
{% set entrypoint = stack.entrypoint or '' %}

{# --- JAVA/KOTLIN --- #}
{% if stack.language in ['java', 'kotlin'] %}
{% if stack.build_tool == 'maven' %}
# Multi-stage build for Java/Kotlin with Maven
FROM maven:3.9-eclipse-temurin-{{ stack.java_version or '17' }} AS builder
WORKDIR /app

# Copy only POM first for dependency caching
{% if project_dir != '.' %}
COPY {{ project_dir }}/pom.xml ./pom.xml
{% else %}
COPY pom.xml ./pom.xml
{% endif %}

# Download dependencies (cached by Docker layer)
RUN mvn dependency:go-offline -B

# Copy source code
{% if project_dir != '.' %}
COPY {{ project_dir }}/src ./src
{% else %}
COPY src ./src
{% endif %}

# Build the application
RUN mvn package -DskipTests -B

# Runtime stage
FROM eclipse-temurin:{{ stack.java_version or '17' }}-jre-alpine
WORKDIR /app
COPY --from=builder /app/target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]

{% elif stack.build_tool == 'gradle' %}
# Multi-stage build for Java/Kotlin with Gradle
FROM gradle:8-jdk{{ stack.java_version or '17' }} AS builder
WORKDIR /app

# Copy Gradle files first for dependency caching
{% if project_dir != '.' %}
COPY {{ project_dir }}/build.gradle* {{ project_dir }}/settings.gradle* ./
{% else %}
COPY build.gradle* settings.gradle* ./
{% endif %}

# Copy source code
{% if project_dir != '.' %}
COPY {{ project_dir }}/src ./src
{% else %}
COPY src ./src
{% endif %}

# Build the application
RUN gradle build --no-daemon -x test

# Runtime stage
FROM eclipse-temurin:{{ stack.java_version or '17' }}-jre-alpine
WORKDIR /app
COPY --from=builder /app/build/libs/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]

{% else %}
# Fallback for other Java build tools
FROM eclipse-temurin:{{ stack.java_version or '17' }}
WORKDIR /app
COPY . .
{% endif %}

{# --- PYTHON --- #}
{% elif stack.language == 'python' %}
{% if stack.build_tool == 'poetry' %}
# Multi-stage build for Python with Poetry
FROM python:{{ stack.python_version or '3.11' }}-slim AS builder
WORKDIR /app

# Install Poetry
RUN pip install --no-cache-dir poetry

# Copy dependency files first
{% if project_dir != '.' %}
COPY {{ project_dir }}/pyproject.toml {{ project_dir }}/poetry.lock* ./
{% else %}
COPY pyproject.toml poetry.lock* ./
{% endif %}

# Install dependencies
RUN poetry config virtualenvs.in-project true && \
    poetry install --only main --no-interaction --no-ansi --no-root

# Copy source code
{% if project_dir != '.' %}
COPY {{ project_dir }} .
{% else %}
COPY . .
{% endif %}

# Runtime stage
FROM python:{{ stack.python_version or '3.11' }}-slim
WORKDIR /app
COPY --from=builder /app/.venv /app/.venv
COPY --from=builder /app /app
ENV PATH="/app/.venv/bin:$PATH"

{% if stack.framework == 'fastapi' %}
EXPOSE 8000
CMD ["uvicorn", "{{ entrypoint.replace('.py', '').replace('/', '.') if entrypoint else 'main' }}:app", "--host", "0.0.0.0", "--port", "8000"]
{% elif stack.framework == 'django' %}
EXPOSE 8000
CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
{% elif stack.framework == 'flask' %}
EXPOSE 5000
CMD ["flask", "run", "--host=0.0.0.0"]
{% else %}
CMD ["python", "{{ entrypoint or 'main.py' }}"]
{% endif %}

{% elif stack.build_tool == 'pipenv' %}
# Multi-stage build for Python with Pipenv
FROM python:{{ stack.python_version or '3.11' }}-slim AS builder
WORKDIR /app

# Install Pipenv
RUN pip install --no-cache-dir pipenv

# Copy dependency files
{% if project_dir != '.' %}
COPY {{ project_dir }}/Pipfile {{ project_dir }}/Pipfile.lock ./
{% else %}
COPY Pipfile Pipfile.lock ./
{% endif %}

# Install dependencies
RUN PIPENV_VENV_IN_PROJECT=1 pipenv install --deploy

# Copy source code
{% if project_dir != '.' %}
COPY {{ project_dir }} .
{% else %}
COPY . .
{% endif %}

# Runtime stage
FROM python:{{ stack.python_version or '3.11' }}-slim
WORKDIR /app
COPY --from=builder /app/.venv /app/.venv
COPY --from=builder /app /app
ENV PATH="/app/.venv/bin:$PATH"
CMD ["python", "{{ entrypoint or 'main.py' }}"]

{% else %}
# Multi-stage build for Python with pip
FROM python:{{ stack.python_version or '3.11' }}-slim AS builder
WORKDIR /app

# Copy requirements
{% if project_dir != '.' %}
COPY {{ project_dir }}/requirements*.txt ./
{% else %}
COPY requirements*.txt ./
{% endif %}

# Install dependencies
RUN pip install --no-cache-dir --target=/app/deps -r requirements.txt

# Copy source code
{% if project_dir != '.' %}
COPY {{ project_dir }} .
{% else %}
COPY . .
{% endif %}

# Runtime stage
FROM python:{{ stack.python_version or '3.11' }}-slim
WORKDIR /app
ENV PYTHONPATH="/app/deps:$PYTHONPATH"
COPY --from=builder /app/deps /app/deps
COPY --from=builder /app /app

{% if stack.framework == 'fastapi' %}
EXPOSE 8000
CMD ["python", "-m", "uvicorn", "{{ entrypoint.replace('.py', '').replace('/', '.') if entrypoint else 'main' }}:app", "--host", "0.0.0.0", "--port", "8000"]
{% elif stack.framework == 'django' %}
EXPOSE 8000
CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
{% elif stack.framework == 'flask' %}
EXPOSE 5000
ENV FLASK_APP={{ entrypoint or 'app.py' }}
CMD ["python", "-m", "flask", "run", "--host=0.0.0.0"]
{% else %}
CMD ["python", "{{ entrypoint or 'main.py' }}"]
{% endif %}

{% endif %}

{# --- NODE.JS/TYPESCRIPT --- #}
{% elif stack.language in ['nodejs', 'typescript'] %}
# Multi-stage build for Node.js/TypeScript
FROM node:{{ stack.node_version or '20' }}-alpine AS builder
WORKDIR /app

# Copy package files first for dependency caching
{% if project_dir != '.' %}
COPY {{ project_dir }}/package*.json {{ project_dir }}/yarn.lock* {{ project_dir }}/pnpm-lock.yaml* ./
{% else %}
COPY package*.json yarn.lock* pnpm-lock.yaml* ./
{% endif %}

# Install dependencies based on lock file
{% if stack.build_tool == 'pnpm' %}
RUN corepack enable pnpm && pnpm install --frozen-lockfile
{% elif stack.build_tool == 'yarn' %}
RUN yarn install --frozen-lockfile
{% else %}
RUN npm ci
{% endif %}

# Copy source code
{% if project_dir != '.' %}
COPY {{ project_dir }} .
{% else %}
COPY . .
{% endif %}

# Build (if TypeScript or needs compilation)
{% if stack.language == 'typescript' or stack.framework in ['react', 'nextjs', 'vue', 'nuxt', 'angular'] %}
RUN npm run build
{% endif %}

# Runtime stage
{% if stack.framework == 'nextjs' %}
FROM node:{{ stack.node_version or '20' }}-alpine
WORKDIR /app
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./
COPY --from=builder /app/public ./public
EXPOSE 3000
CMD ["npm", "run", "start"]

{% elif stack.framework == 'nuxt' %}
FROM node:{{ stack.node_version or '20' }}-alpine
WORKDIR /app
COPY --from=builder /app/.output ./.output
EXPOSE 3000
CMD ["node", ".output/server/index.mjs"]

{% elif stack.framework in ['react', 'vue', 'angular'] %}
# Static frontend - serve with nginx
FROM nginx:alpine
COPY --from=builder /app/{{ stack.build_output_dir or 'dist' }} /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]

{% else %}
# Node.js backend
FROM node:{{ stack.node_version or '20' }}-alpine
WORKDIR /app
COPY --from=builder /app/{{ stack.build_output_dir or 'dist' }} ./{{ stack.build_output_dir or 'dist' }}
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./
EXPOSE 3000
CMD ["npm", "run", "start:prod"]
{% endif %}

{# --- GO --- #}
{% elif stack.language == 'go' %}
# Multi-stage build for Go
FROM golang:{{ stack.go_version or '1.21' }}-alpine AS builder
WORKDIR /app

# Copy go.mod and go.sum first for dependency caching
{% if project_dir != '.' %}
COPY {{ project_dir }}/go.mod {{ project_dir }}/go.sum* ./
{% else %}
COPY go.mod go.sum* ./
{% endif %}

# Download dependencies
RUN go mod download

# Copy source code
{% if project_dir != '.' %}
COPY {{ project_dir }} .
{% else %}
COPY . .
{% endif %}

# Build the application (static binary)
{% set go_entrypoint = entrypoint or 'main.go' %}
{% if 'cmd/' in go_entrypoint %}
{% set build_path = './' + go_entrypoint.rsplit('/', 1)[0] %}
{% else %}
{% set build_path = '.' %}
{% endif %}
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o /app/server {{ build_path }}

# Runtime stage - minimal image
FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /app
COPY --from=builder /app/server .
EXPOSE 8080
CMD ["./server"]

{# --- .NET/C# --- #}
{% elif stack.language == 'dotnet' %}
# Multi-stage build for .NET
FROM mcr.microsoft.com/dotnet/sdk:{{ stack.dotnet_framework_version or '8.0' }} AS builder
WORKDIR /app

# Copy csproj files first for dependency caching
{% if project_dir != '.' %}
COPY {{ project_dir }}/*.csproj ./
{% else %}
COPY *.csproj ./
{% endif %}

# Restore dependencies
RUN dotnet restore

# Copy source code
{% if project_dir != '.' %}
COPY {{ project_dir }} .
{% else %}
COPY . .
{% endif %}

# Build and publish
RUN dotnet publish -c Release -o /app/publish --no-restore

# Runtime stage
{% if stack.framework == 'blazor' %}
FROM mcr.microsoft.com/dotnet/aspnet:{{ stack.dotnet_framework_version or '8.0' }}
{% else %}
FROM mcr.microsoft.com/dotnet/aspnet:{{ stack.dotnet_framework_version or '8.0' }}
{% endif %}
WORKDIR /app
COPY --from=builder /app/publish .
EXPOSE 8080
ENV ASPNETCORE_URLS=http://+:8080
ENTRYPOINT ["dotnet", "{{ stack.config_file.replace('.csproj', '.dll') if stack.config_file else 'App.dll' }}"]

{# --- PHP --- #}
{% elif stack.language == 'php' %}
# Multi-stage build for PHP
FROM composer:2 AS builder
WORKDIR /app

# Copy composer files first for dependency caching
{% if project_dir != '.' %}
COPY {{ project_dir }}/composer.json {{ project_dir }}/composer.lock* ./
{% else %}
COPY composer.json composer.lock* ./
{% endif %}

# Install dependencies
RUN composer install --no-dev --optimize-autoloader --no-scripts --no-interaction

# Copy source code
{% if project_dir != '.' %}
COPY {{ project_dir }} .
{% else %}
COPY . .
{% endif %}

# Run post-install scripts
RUN composer dump-autoload --optimize

# Runtime stage
{% if stack.framework == 'laravel' %}
FROM php:{{ stack.php_version or '8.2' }}-fpm-alpine
RUN apk add --no-cache nginx supervisor
WORKDIR /var/www/html
COPY --from=builder /app .
RUN chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache
EXPOSE 80
CMD ["php-fpm"]

{% elif stack.framework == 'symfony' %}
FROM php:{{ stack.php_version or '8.2' }}-fpm-alpine
WORKDIR /var/www/html
COPY --from=builder /app .
RUN chown -R www-data:www-data var
EXPOSE 9000
CMD ["php-fpm"]

{% else %}
FROM php:{{ stack.php_version or '8.2' }}-fpm-alpine
WORKDIR /var/www/html
COPY --from=builder /app .
EXPOSE 9000
CMD ["php-fpm"]
{% endif %}

{% else %}
# Unknown language - generic Dockerfile
FROM alpine:latest
WORKDIR /app
COPY . .
CMD ["/bin/sh"]
{% endif %}

# Labels for image metadata
LABEL org.opencontainers.image.title="{{ metadata.name }}"
LABEL org.opencontainers.image.version="{{ metadata.version }}"
LABEL org.opencontainers.image.vendor="AutoPipe"
LABEL autopipe.language="{{ stack.language }}"
LABEL autopipe.framework="{{ stack.framework }}"
LABEL autopipe.build_tool="{{ stack.build_tool }}"
